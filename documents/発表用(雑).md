# だいたいの大枠

バックエンド兼インフラ担当の視点からいくつかを取り上げていく。

1. バックエンドの設計思想について
1. 形態素解析を用いた NG ワード判定
1. パーサーについて
1. バリデーションについて
1. メール送信機能
1. ESLint の採用
1. Git の利用について。
   1. GithubActions の活用
1. 使用したサーバーについて。
1. AWS S3 を利用していることと、アクセス制御について。
   1. メディアプロキシを自前で用意し使用している点。
1. CDN を利用したコンテンツキャッシュ
1. 一部のユーザーアップロード画像について、WebP 形式に変換している点。
1. サーバーサイドに TypeScript を利用したことと、その優位性について。
1. Copilot 等々の利用ツール紹介

# 細かい中身

## バックエンドの設計思想について

「全てを API で」を元に、期間や実装コストの実現可能な範囲で可能な限り多くの操作を API でできるようにしました。  
これにより、例えば将来的に「スマホアプリ版も欲しい」といったニーズが出てきた場合にも対応しやすいようにしています。

## 形態素解析を用いた NG ワード判定

形態素解析を用いて、NG ワードを判定します。  
幅広い年代をターゲットとしており、NG ワードの実装は絶対に必要であると判断したため本機能を追加しました。  
これは、形態素解析ライブラリの MeCab を用いて実装しております。  
単純な正規表現を用いた判定に比べ、単語単位での抽出を行うため、誤検出が少ないという特徴があります。
自身の管理しているほかのサーバーで公開しているものを利用しています。

## Git の利用について。

私の作業分に関して、Git を使用して開発を進めました。  
かなり難度の高そうな実験的な物に関しては、1 機能 1 ブランチで開発を行い、実装が済んだら develop ブランチに push していく流れで開発を進めていました。

## 使用したサーバーについて

今回利用したのは Oracle Cloud Infrastructure(以降 OCI と呼びます)の無料枠で借りられるサーバーで、  
ARM アーキテクチャを利用した 4OCPU、メモリが 24GB のサーバーです。  
画像の保存には AWS S3 を利用しています。  
データベースには MySQL を利用していて、毎朝 1 回データベースをバックアップ、外部ブロックストレージへアップロードするようにしています。
ドメインや S3 も含め、今回はすでに自身の使っているものの一部を割り当てる形で提供しております。

## AWS S3 を利用していることと、アクセス制御について。

AWS S3 を用いることで、HEW という枠ではなく実際に運用する際にも対応できるような構成にしています。  
アクセス制御についてですが、S3 へのアクセス(これは画像のアップロードもダウンロード、閲覧も含めて)は接続元 IP 制限を施しています。

### メディアプロキシ

S3 へアクセスする際にはメディアプロキシを経由するようにしています。これにより、S3 への接続元 IP 制限を無視してアクセスをすることができるようになりますが、後述する CDN によるコンテンツキャッシュの恩恵を受けることができるようになります。

## CDN を利用したコンテンツキャッシュ

今回は Cloudflare を利用したコンテンツキャッシュを利用しています。  
これにより、キャッシュによるアクセス高速化の恩恵に加えて、S3 への通信量も減らすことができコスト面でも恩恵を受けることができます。

## 一部のユーザーアップロード画像について、WebP 形式に変換している点。

一部のユーザーアップロード画像について、WebP 形式に変換しています。
これにより、画像の品質を維持したまま圧倒的に画像の容量を減らすことができます。
今回@ulabeler として準備したアカウントのアイコン画像で言えば、もともと 4,488Byte で S3 に保存されていた画像が、WebP に変換する処理を挟んだことで 1,016Byte になり、およそ 77%の容量削減をすることができました。
ストレージコストを減らすことができるだけでなく、画像読み込み時の通信負荷削減により、ユーザーがより快適に使うことができるようになります。

## サーバーサイドに TypeScript を採用

サーバーサイドに TypeScript を採用しており、ルーティングは全て TypeScript で実装しています。  
これは変数に型を与えることができる、という圧倒的メリットがあり、意図しない型の値の代入を防ぐことができます。  
変数に厳格な型の概念があることによるメリットは Java をはじめとした他言語を見ると理解していただけるかと思います。  
分かりやすいケースで言うと、DB へのデータ格納時を思い浮かべていただけるとわかりやすいかと思います。  
(簡単な insert 用意して型エラー見せるなどしつつ)  
TypeScript には型エイリアスという概念があり、乱暴な言い方をすれば型に名前を付けることができます。  
これを活用してテーブルのカラム名と型を事前に定義しておき、insert 前に型を指定して値を入れることで、エラーを防ぐことができます。  
これはごく一部に過ぎませんが、他にもいくつかのメリットがあることから TypeScript を採用しました。

## ESLint の採用

ESLint は、JavaScript/TypeScript のコードをチェックするためのツールです。  
これの採用により、それぞれで差異が出がちな変数の命名規則、インデントなどのコーディング規約を統一することが容易にすることができるようになります。  
複数人での開発時の効率を上げるための環境整備の一環として導入しました。

# 時間余ったら

1. パーサーの話
1. あとなんか
